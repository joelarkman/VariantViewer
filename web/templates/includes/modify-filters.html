{% load add_class %}

<div class="ui segments" style="display: flex;min-width: 75%;max-width: 90%;max-height: 90%;">
    <div class="ui left aligned clearing segment">
        <h3 class="ui header" style="margin:0">Modify Filters</h3>
    </div>

    <div class="ui left aligned segment">
        <div class="ui info message">
            <b>Pipeline preset active</b>
        </div>
    </div>

    <div class="ui left aligned segment"
        style="display: flex;flex-direction: row;;overflow: hidden;padding: 0;min-height: 40vh;">

        <div style="display: flex;flex: 1;flex-direction: column;margin-right: auto;overflow-y: auto;padding: 14px;">

            <form class="ui form" id="js-modify-filter-form" method="post"
                action="{% url 'modify_filters' ss_sample=ss_sample.id run=run.id filter=filter %}">
                {% csrf_token %}
                {{form.non_field_errors}}
                {{form.errors}}
                <div class="ui fields" style="display: flex;align-items: flex-start;justify-content: space-between;">
                    <div class="field" style="flex: 0 0 30%;">
                        <label for="id_genekey">Name:</label>
                        <div class="ui input">
                            {{form.name}}
                        </div>

                    </div>

                    <div class="field" style="flex: 1;">
                        <label for="id_genekey">Description:</label>
                        <div class="ui input">
                            {{form.description}}
                        </div>
                    </div>
                </div>



                <span style="font-size: 13px;font-weight: 700;">Filters:</span>

                {{ formset.management_form }}
                <div id="form-set" class="ui top attached raised tertiary segment"
                    style="display: flex;gap: 15px;flex-direction: column;margin-top: 4px;padding: 10px;">

                    <div class="title-row"
                        style="display: flex; flex-direction: row;align-items: center;justify-content: space-between;flex-wrap: wrap; ">

                        <span style="width: 196px;">Field:</span>
                        <span style="width:196px">Filter type:</span>
                        <span style="width: 177px;">Value:</span>
                        <span style="width: 38.5156px;"></span>
                    </div>

                    {% for form in formset.forms %}
                    {{form.non_field_errors}}
                    <!-- {{form.errors}} -->
                    <div class="ui form form-row"
                        style="display: flex; flex-direction: row;align-items: center;justify-content: space-between; flex-wrap: wrap;">
                        {{ form.id }}
                        {{ form.field}}
                        {{ form.filter_type}}
                        <div class="ui input {% if form.value.errors %}error{%endif%}">
                            {{ form.value}}
                        </div>

                        <!-- <div class="ui input">
                            <input readonly type="text" value="{{form.value.value}}">
                        </div> -->

                        {{ form.DELETE|add_class:"hidden" }}
                        <div class="ui negative icon button remove-formset-button">
                            <i class="trash icon"></i>
                        </div>
                    </div>
                    {% endfor %}



                </div>

                <div class="ui bottom attached raised segment add-container" style="padding: 10px;">
                    <div class='ui fluid button' value="Add More" id="add_more"><i class="plus icon"></i></div>
                </div>


                <div id="empty-form" style="display:none">
                    <div class="form-row"
                        style="display: flex; flex-direction: row;align-items: center;;justify-content: space-between; flex-wrap: wrap;">
                        {{ formset.empty_form.id }}
                        {{ formset.empty_form.field }}
                        {{ formset.empty_form.filter_type }}
                        <div class="ui input">
                            {{ formset.empty_form.value }}
                        </div>
                        {{ formset.empty_form.DELETE|add_class:"hidden" }}
                        <div class="ui negative icon button remove-formset-button">
                            <i class="trash icon"></i>
                        </div>
                    </div>
                </div>
            </form>
        </div>


        <div class="ui attached segment"
            style="flex-direction: column;flex: 0 1 22%;padding: 0;height: 100%;margin: 0;border-top: none;border-bottom: none;overflow-y: auto;overflow-x: hidden;min-height: 285px;">

            <div class="ui vertical attached menu" style="border: none;width: 100%;">

                <div class="ui attached segment"
                    style="padding-top: 9px;padding-bottom: 9px; padding-left: 12px;padding-right: 12px ;font-size: 12px; font-weight: 700; line-height: 12px;border-left: none;border-right: none;border-top: none; color: rgba(0,0,0,.6); background-color: #e8e8e8;">
                    <i class="redo icon" style="margin-right: 9px;width: 9px;"></i>
                    PIPELINE DEFAULT
                </div>


                <a class="active primary item">
                    TSMP v1
                    <i class="check icon"></i>
                </a>


                <div class="ui attached segment"
                    style="padding-top: 9px;padding-bottom: 9px; padding-left: 12px;padding-right: 12px ;font-size: 12px; font-weight: 700; line-height: 12px;border-left: none;border-right: none;color: rgba(0,0,0,.6); background-color: #e8e8e8;">
                    <i class="pen icon" style="margin-right: 9px;width: 9px;"></i>
                    CUSTOM FILTER
                </div>

                <a class=" item">
                    {{filter.name}}
                    <i class="check icon"></i>
                </a>

                <div class="ui attached segment"
                    style="padding-top: 9px;padding-bottom: 9px; padding-left: 12px;padding-right: 12px ;font-size: 12px; font-weight: 700; line-height: 12px;border-left: none;border-right: none; color: rgba(0,0,0,.6); background-color: #e8e8e8;">
                    <i class="user icon" style="margin-right: 9px;width: 9px;"></i>
                    OTHER USER FILTERS
                </div>

                <div style="margin-top:13px">
                    <span style="margin-left: 16px;">None</span>
                </div>


            </div>


        </div>

    </div>

    <div class="ui secondary left aligned clearing segment">
        <input type="submit" form="js-modify-filter-form"
            class="ui right floated primary button js-modify-filter-form-submit" data-stv='' style="margin-left: 10px;"
            value="Save changes">
        <div class="ui right floated button filter-settings-close">Cancel</div>
    </div>

</div>

<script type="text/javascript">
    $(function () {
        $('.ui.dropdown')
            .dropdown({
                direction: 'upward'
            });

        $('#add_more').click(function () {
            var form_idx = $('#id_items-TOTAL_FORMS').val();
            $('#form-set').append($('#empty-form').html().replace(/__prefix__/g, form_idx));
            $('#id_items-TOTAL_FORMS').val(parseInt(form_idx) + 1);

            $('.ui.dropdown')
                .dropdown({
                    direction: 'upward'
                })
                ;

            $('.remove-formset-button').click(function () {
                delete_form(this)
            });

            $('#form-set').show()
            $('.add-container').addClass('bottom attached')
        });

        $('.remove-formset-button').click(function () {
            delete_form(this)
        });

        function delete_form(button) {
            $(button).siblings('[id*=DELETE]').prop('checked', true)
            $(button).parents('.form-row').hide()
            $('#form-set').toggle($('.form-row:visible').length != 0);
            $('.add-container').toggleClass('bottom attached', $('.form-row:visible').length != 0);
        }

        // $('[id*=DELETE]').hide()
        $('#form-set').toggle($('.form-row:visible').length != 0);
        $('.add-container').toggleClass('bottom attached', $('.form-row:visible').length != 0);


        // var propertyChangeUnbound = false;
        // $("#js-modify-filter-form").children().bind("propertychange", function (e) {
        //     if (e.originalEvent.propertyName == "value") {
        //         $('.js-modify-filter-form-submit').removeClass('disabled')
        //         //do other stuff
        //     }
        // });

        // $("#js-modify-filter-form").children().bind("input click", function () {
        //     if (!propertyChangeUnbound) {
        //         $("#product_descriptioncontent").unbind("propertychange");
        //         propertyChangeUnbound = true;
        //     }
        //     $('.js-modify-filter-form-submit').removeClass('disabled')
        //     //do other stuff
        // });
    })

</script>