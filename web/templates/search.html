{% extends 'base.html' %}

{% load static %}
{% load humanize %}

{% block stylesheet %}
<style>
    table.dataTable.no-footer {
        border-bottom: 0 !important;
        border-top: none;
    }
</style>
{% endblock %}

{% block javascript %}
<script>
    $(document).ready(function () {

        // Initiate coverage tables
        var sample_table = $('.samples-list-table').DataTable({
            'serverSide': true,
            'ajax': '/api/sample_list?format=datatables',
            "deferRender": true,
            'processing': true,
            'columns': [
                {
                    "data": "slug",
                    "render": function (data, type, row, meta) {

                        data = "<a href='/sample/" + data + "' class='ui small icon button' style='margin:0px;'><i class='external alternate icon'></i></a>"
                        return data;
                    },
                    "orderable": false,
                    "className": 'center aligned',
                },
                { 'data': 'sample_id' },
                { 'data': 'lab_no' },
                { 'data': 'samplesheets', 'name': 'samplesheets__run.worksheet' },
                { 'data': 'panel', 'name': 'samplesheets__run__pipeline_version__pipeline__name' },
                { 'data': 'completed_at', 'name': 'samplesheets__run__completed_at' },
                { 'data': 'qc_status', 'name': 'samplesheets__run__qc_status' },


            ],
            "scrollCollapse": true,
            "paging": true,
            "pageLength": 25,
            "footer": false,
            "dom": '<"top">rt<"bottom">ip<"clear">',
            "language": {
                "emptyTable": "No relevent samples",
                'loadingRecords': '&nbsp;',
                'processing': 'Loading...'
            },
            "order": [[5, "desc"]],


        });

        function applySearches() {
            table = sample_table
            search = $('#mySearch').val()
            pipeline = $('#pipeline-selection').val()
            table.search(search).column(4).search(pipeline).draw();
        }

        $('#samples-list tbody').on('click', 'tr', function () {
            //  retreive sample name from col 2 of table
            var sample = $(this).find("td").eq(1).text();
            window.location.href = "/sample/" + sample;
        });


        $('.pipeline-choice').on('click', function () {
            $('.pipeline-choice').removeClass('active')
            $(this).addClass('active')

            if ($(this).text() == 'All') {
                $('#pipeline-selection').val('')

            } else {
                $('#pipeline-selection').val($(this).text())

            }

            applySearches()
        });

        // Set up custom search of both tables
        $('#mySearch').on('keyup click', function () {
            applySearches()
        });

        $("#table-footer").append($(".dataTables_info"));
        $("#table-footer").append($(".dataTables_paginate"));


        $('#search-filters-toggle').on('click', function () {
            $(this).toggleClass('red')

            if ($(this).hasClass('red')) {
                $(this).attr("data-tooltip", "Hide Filter");
            } else {
                $(this).attr("data-tooltip", "Show Filters");
            }

            $('#search-filters').slideToggle()
        })


    });




</script>
{% endblock %}


{% block content %}

<!-- Page Header -->
<div id="page-header" class="ui inverted vertical masthead left aligned segment">
    <img id="page-header-background" src="{% static 'header-background.jpeg' %}">

    <div id='page-header-title'>

        <div id="page-header-title-leftstack">
            <h1 id="page-header-title-text">Sample Search</h1>
            <div class="ui large breadcrumb">
                <a class="ui compact tiny grey basic inverted button">Home</a>
                <i class="right chevron icon divider"></i>
                <a class="ui compact tiny grey basic inverted button">Rare disease</a>
                <i class="right chevron icon divider"></i>
                <a class="ui compact tiny grey basic inverted disabled button">Search</a>
            </div>

        </div>

        <!-- <div id="page-header-title-right-buttons" class="ui three item menu">
            <a class="active item main-tabs-link active" data-tab='variants-tab'>Variants</a>
            <a class="item main-tabs-link" data-tab="qc">QC Metrics</a>
            <a class="item main-tabs-link" data-tab="coverage">Coverage</a>
        </div> -->

    </div>
</div>

<!-- Tab Utility Bar -->
<div id="tab-utility-bar" class="ui attached segment">

    <span class="title">SEARCH</span>

    <div class="item-divider"></div>

    <div class="ui small icon input" style="width:100%;">
        <input type="text" placeholder="Search" id="mySearch">
        <i class="circular search link icon"></i>
    </div>

    <div class="item-divider" style="margin-left: 15px;"></div>

    <div id="search-filters-toggle" class="ui small icon button" data-tooltip='Show Filters'
        data-position="bottom right">
        <i class="filter icon"></i>
    </div>
</div>

<div id="search-filters" class="ui attached segment hidden"
    style="border-top: none;height: 7cm;background-color: #F8F8F8;">
    <h3>Filters</h3>


    <div class="ui primary buttons">
        <button class="ui active button pipeline-choice">All</button>
        <button class="ui button pipeline-choice">TSMP</button>
        <button class="ui button pipeline-choice">TSO</button>
    </div>
    <input type="hidden" id="pipeline-selection" value="">

</div>

<div id="samples-list" style="flex: 2;display: flex;overflow: hidden;flex-direction: column;">

    <div class="ui attached segment"
        style="padding: 0;border-top: none;flex: 1;overflow-y: scroll;overflow-x: hidden;background-color: #F8F8F8;">

        <table class='ui samples-list-table selectable celled structured table '
            style="width: 100%;table-layout: fixed;">
            <thead>
                <tr>
                    <th rowspan="2" width='40px'></th>
                    <th rowspan="2"> Sample ID </th>
                    <th rowspan="2"> Lab no. </th>
                    <th colspan="4"> Latest worksheet </th>
                </tr>
                <tr>
                    <th> Name </th>
                    <th> Pipeline </th>
                    <th> Completed </th>
                    <th> QC Status </th>
                </tr>
            </thead>


        </table>

    </div>



</div>

<div id="table-footer" class="ui attached segment"
    style="border-top:none;display: flex;flex-direction: row;align-items: center;justify-content: space-between;">

</div>

{% endblock %}